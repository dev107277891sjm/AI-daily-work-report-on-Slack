# Daily Work Report to Slack — Project Plan

## 1. Overview

A Windows desktop application that:
- Tracks active window titles and processes in real time
- Computes exact running time per window/process
- Stores all data in PostgreSQL
- Generates daily reports using ChatGPT
- Sends reports to a Slack channel at a configurable time and timezone
- Provides a system tray icon and a simple web UI for settings and past reports
- Keeps secrets in `.env`

---

## 2. Architecture

### 2.1 Technology Stack

| Layer | Technology | Purpose |
|-------|------------|--------|
| Language | Python 3.10+ | Core app, Windows APIs, backend |
| Process/Window tracking | `psutil`, `pywin32` (win32gui) | List processes, foreground window, window titles |
| Database | PostgreSQL | Persistent storage of sessions and settings |
| ORM / DB access | SQLAlchemy 2.x | Models, migrations, queries |
| Scheduler | APScheduler | Daily report at specific time/timezone |
| Slack | `slack_sdk` or `requests` | Send messages to Slack channel |
| AI report | OpenAI API (ChatGPT) | Generate report text from statistics |
| Tray icon | `pystray` + `Pillow` | System tray menu and icon |
| Web UI | Flask + Jinja2 + minimal JS | Settings, past reports, start/stop |
| Config / secrets | `python-dotenv` | Load from `.env` |

### 2.2 High-Level Flow

```
[Tracker Service] --> polls foreground window + process list
        |
        v
[PostgreSQL] <-- store: window_sessions, process_sessions, daily_aggregates
        |
        v
[Scheduler] --> at configured time (timezone): trigger report job
        |
        v
[Report Generator] --> load stats from DB --> call ChatGPT --> format report
        |
        v
[Slack Sender] --> POST to Slack webhook/API --> message in channel
```

- **Tray**: Start/stop tracking, open UI, quit. Optional: “Send report now”.
- **Web UI**: Configure Slack webhook, report time, timezone, OpenAI API key; view/edit settings; view past reports (from DB).

---

## 3. Module Breakdown

### 3.1 Project Structure

```
Slack Webhook/
├── .env.example
├── .env                    # (gitignored) secrets
├── requirements.txt
├── README.md
├── PROJECT_PLAN.md
├── config/
│   └── settings.py         # Load from env, validate
├── db/
│   ├── __init__.py
│   ├── models.py           # SQLAlchemy models
│   ├── session.py          # Engine, Session factory
│   └── migrations/         # Optional: Alembic
├── tracker/
│   ├── __init__.py
│   ├── window_tracker.py   # Poll foreground window, process name, duration
├── report/
│   ├── __init__.py
│   ├── generator.py        # Build stats from DB, call OpenAI
│   └── slack_sender.py     # Send message to Slack
├── scheduler/
│   └── job.py              # APScheduler: daily report job
├── ui/
│   ├── __init__.py
│   ├── tray.py             # pystray tray icon and menu
│   └── web/
│       ├── app.py          # Flask app
│       ├── templates/
│       └── static/
├── main.py                 # Entry: init DB, start tray, start tracker, scheduler, web UI
└── scripts/
    └── init_db.py          # Create tables (or Alembic upgrade)
```

### 3.2 Database Schema (PostgreSQL)

- **window_sessions**  
  - id, process_name, window_title, started_at, ended_at, duration_seconds, machine_user (optional), created_at.

- **process_sessions** (optional, for process-level aggregation)  
  - id, process_name, started_at, ended_at, duration_seconds, created_at.

- **daily_reports**  
  - id, report_date (date), report_text (generated by AI), sent_at, slack_channel_id (optional), created_at.

- **settings** (key-value for UI-stored config)  
  - key (e.g. `slack_webhook_url`, `report_time`, `timezone`, `openai_api_key`), value (encrypted or plain per key), updated_at.

Secrets (Slack webhook, OpenAI API key) should be read from `.env` at runtime; the UI only displays masked values and allows “set from env” or “paste and save” (value stored in DB or only in env, depending on security preference). Plan: store in `.env` only; UI just shows placeholders and a link to edit `.env`.

---

## 4. Detailed Component Design

### 4.1 Config (`config/settings.py`)

- Use `python-dotenv` to load `.env`.
- Required: `DATABASE_URL`, `SLACK_WEBHOOK_URL` (or `SLACK_BOT_TOKEN` + channel), `OPENAI_API_KEY`.
- Optional: `REPORT_TIME` (e.g. `18:00`), `TIMEZONE` (e.g. `Europe/Kyiv`), `FLASK_SECRET_KEY`, `TRACKER_POLL_INTERVAL_SECONDS`.
- Validate on startup; fail fast with clear message if required vars missing.

### 4.2 Tracker (`tracker/window_tracker.py`)

- Run in a background thread or async loop.
- Every N seconds (e.g. 5–10):
  - Get foreground window: `win32gui.GetForegroundWindow()` then `win32gui.GetWindowText(hwnd)`.
  - Get process name for that window (e.g. via `win32process.GetWindowThreadProcessId` + `psutil.Process(pid).name()`).
- If foreground window changed from last poll:
  - End previous “session” (set `ended_at`, compute `duration_seconds`), insert row.
  - Start new session (process_name, window_title, started_at).
- If same window: do nothing (session continues).
- Handle minimized/hidden: still consider “foreground” as the last active window; optional: detect when user is idle (no focus change for X minutes) and pause or cap session.
- All writes go to PostgreSQL via SQLAlchemy.

### 4.3 Report Generator (`report/generator.py`)

- Input: `report_date` (date).
- Query DB: aggregate by `process_name` and optionally `window_title` (sum of `duration_seconds`), filter by `report_date`.
- Build a short structured summary (e.g. table: process, total minutes).
- Call OpenAI API (e.g. `gpt-4o-mini` or `gpt-4`) with prompt: “Given this daily activity statistics, write a brief professional daily work report (3–5 sentences).” Include the summary in the prompt.
- Return the generated text (and optionally the raw stats for logging).

### 4.4 Slack Sender (`report/slack_sender.py`)

- If using webhook: POST JSON `{"text": report_text}` to `SLACK_WEBHOOK_URL`.
- If using Bot Token: use `slack_sdk.WebhookClient` or `chat.postMessage` with channel ID.
- On success: store in `daily_reports` (report_text, sent_at, report_date).
- On failure: log and optionally retry; store failure state so UI can show “last report failed”.

### 4.5 Scheduler (`scheduler/job.py`)

- APScheduler with a single job: “daily report”.
- Run at `REPORT_TIME` in `TIMEZONE` (e.g. `CronTrigger(hour=18, minute=0, timezone=timezone(TIMEZONE))`).
- Job body: call report generator for “today”, then Slack sender, then persist to `daily_reports`.

### 4.6 Tray (`ui/tray.py`)

- Create tray icon (pystray) with menu:
  - “Open Dashboard” → open browser to `http://127.0.0.1:PORT`.
  - “Start / Stop tracking” (toggle).
  - “Send report now” (optional).
  - “Quit”.
- Icon: simple PNG (included in repo) or generated with Pillow (e.g. clock or document icon).

### 4.7 Web UI (`ui/web/`)

- **Flask** on a fixed port (e.g. 5050), bind to 127.0.0.1 only.
- **Routes**:
  - `GET /` — Dashboard: current status (tracking on/off), last report sent, link to settings.
  - `GET /settings` — Form: report time, timezone, Slack webhook URL (masked), OpenAI key (masked). Values from `.env` + DB (if we store non-secrets in DB). Save: update `.env` or DB; if we keep secrets only in `.env`, show instructions to edit `.env` and restart.
  - `POST /settings` — Save non-secret settings to DB; for secrets, show “set in .env”.
  - `GET /reports` — List past reports (from `daily_reports`), paginated.
  - `GET /reports/<id>` — Single report view.
  - `GET /api/status` — JSON: tracking on/off, last report date.
  - `POST /api/tracking` — Start/stop tracking (toggle).
- **Past work status**: “Reports” page shows report_date, report_text (preview), sent_at; optional: “Activity” page with table of window_sessions for a selected date (from DB).

### 4.8 Main Entry (`main.py`)

1. Load config; validate; exit if invalid.
2. Ensure DB exists and tables are created (`scripts/init_db.py` or Alembic).
3. Start Flask in a daemon thread (or separate process).
4. Start tracker thread (if “tracking on” by default).
5. Start APScheduler (daily report job).
6. Run pystray (blocking) so tray icon and menu work.
7. On “Quit”: stop scheduler, stop tracker, close DB, exit.

---

## 5. Security and .env

- **.env**: `DATABASE_URL`, `SLACK_WEBHOOK_URL`, `OPENAI_API_KEY`, `REPORT_TIME`, `TIMEZONE`, `FLASK_SECRET_KEY`, `TRACKER_POLL_INTERVAL_SECONDS`. Add `.env` to `.gitignore`.
- **.env.example**: Same keys with placeholder values (no real secrets).
- UI must not log or display full secrets; show only “••••••” and “Configured” / “Not set”.

---

## 6. Scalability and Clarity

- **Scalability**: Separate modules (tracker, report, scheduler, ui); DB as single source of truth; add queues (e.g. Redis + Celery) later if report generation becomes heavy.
- **Clarity**: One responsibility per file; type hints; docstrings for public functions; README with setup and run instructions.

---

## 7. Build and Run Order

1. Create repo structure, `requirements.txt`, `.env.example`, `.gitignore`.
2. Implement `config/settings.py`.
3. Implement `db/models.py`, `db/session.py`, `scripts/init_db.py`.
4. Implement `tracker/window_tracker.py` (with mock or real DB write).
5. Implement `report/generator.py` and `report/slack_sender.py`.
6. Implement `scheduler/job.py`.
7. Implement `ui/tray.py` and `ui/web/app.py` (minimal routes first).
8. Implement `main.py` (wire everything).
9. Add “Past reports” and “Activity by date” in UI.
10. Test: run tracker, generate report manually, send to Slack, then automate with scheduler.
11. Document in README: prerequisites (Python 3.10+, PostgreSQL, .env), install, init DB, run, optional: build executable (PyInstaller) for tray.

---

## 8. File Checklist

- [ ] `.env.example`
- [ ] `.gitignore`
- [ ] `requirements.txt`
- [ ] `config/settings.py`
- [ ] `db/models.py`, `db/session.py`, `db/__init__.py`
- [ ] `scripts/init_db.py`
- [ ] `tracker/window_tracker.py`, `tracker/__init__.py`
- [ ] `report/generator.py`, `report/slack_sender.py`, `report/__init__.py`
- [ ] `scheduler/job.py`
- [ ] `ui/tray.py`, `ui/web/app.py`, templates, static
- [ ] `main.py`
- [ ] `README.md`
- [ ] Tray icon asset (e.g. `ui/icon.png`)

This plan is intended to be implemented step by step and then run on a Windows machine with PostgreSQL installed and Slack/OpenAI credentials configured in `.env`.
